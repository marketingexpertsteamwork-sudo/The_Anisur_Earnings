<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel (Upgraded)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 15px;
        }
        .admin-container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .section-content { /* নতুন ক্লাস: সেকশন কন্টেন্ট এর জন্য */
            margin-bottom: 30px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        table th {
            background-color: #4CAF50;
            color: white;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr.banned-user {
            background-color: #ffdddd;
            text-decoration: line-through;
        }
        button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 13px;
            margin: 2px;
        }
        .btn-approve { background-color: #28a745; }
        .btn-deny { background-color: #dc3545; }
        .btn-edit { background-color: #007bff; }
        .btn-bonus { background-color: #ff9800; }
        .btn-save { background-color: #ffc107; color: black; }
        .btn-ban { background-color: #c82333; }
        .btn-unban { background-color: #17a2b8; }
        .btn-deduct { background-color: #6c757d; } /* নতুন বাটন */
        .btn-history { background-color: #17a2b8; } /* নতুন বাটন */
        .btn-notice { background-color: #fd7e14; } /* নতুন বাটন */
        
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
            text-align: center;
        }
        .status-pending { background-color: #ffc107; color: black; }
        .status-approved { background-color: #28a745; }
        .status-denied { background-color: #dc3545; }

        .settings-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .form-group .toggle-switch {
            display: flex;
            align-items: center;
        }
        .form-group .toggle-switch label {
            margin: 0;
            margin-left: 10px;
        }
        .full-width-button {
            grid-column: 1 / -1;
            padding: 12px;
            font-size: 16px;
        }
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-box {
            background-color: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 5px solid #4CAF50;
        }
        .stat-box h3 {
            margin: 0 0 10px 0;
            color: #555;
            font-size: 16px;
        }
        .stat-box p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        .search-container {
            margin-bottom: 15px;
        }
        .search-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        /* --- নতুন মেনু সিস্টেমের জন্য CSS --- */
        .menu-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .menu-btn {
            background-color: #007bff;
            padding: 10px 15px;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }
        .menu-btn.active {
            background-color: #0056b3;
            border-bottom: 3px solid #ffc107;
        }
        /* --- নতুন মোডাল এর জন্য CSS --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="admin-container">
        <h1>Admin Panel (Upgraded)</h1>

        <!-- নতুন ফিচার: মেনু বার -->
        <div class="menu-bar">
            <button class="menu-btn active" onclick="showSection('dashboard')">Dashboard</button>
            <button class="menu-btn" onclick="showSection('settings')">Global Settings</button>
            <button class="menu-btn" onclick="showSection('withdrawals')">Withdrawal Requests</button>
            <button class="menu-btn" onclick="showSection('users')">User Data</button>
            <button class="menu-btn" onclick="showSection('support')">Support Tickets</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section-content">
            <h2>Dashboard</h2>
            <div class="dashboard-stats">
                <div class="stat-box">
                    <h3>Total Users</h3>
                    <p id="total-users">0</p>
                </div>
                <div class="stat-box" style="border-color: #ffc107;">
                    <h3>Pending Withdrawals</h3>
                    <p id="pending-withdrawals">0</p>
                </div>
                <div class="stat-box" style="border-color: #007bff;">
                    <h3>Total Points in Circulation</h3>
                    <p id="total-points">0.00</p>
                </div>
                 <!-- নতুন ফিচার: ড্যাশবোর্ড স্ট্যাটস -->
                <div class="stat-box" style="border-color: #28a745;">
                    <h3>New Users (Today)</h3>
                    <p id="today-new-users">0</p>
                </div>
            </div>
            <!-- নতুন ফিচার: টপ আর্নার লিডারবোর্ড -->
            <div class="table-container">
                <h3>Top 10 Earners</h3>
                <table id="top-earners-table">
                    <thead><tr><th>Rank</th><th>User Name</th><th>Points</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Global Settings Section -->
        <div id="settings" class="section-content" style="display:none;">
            <h2>Global Settings</h2>
            <div class="settings-form">
                <div class="form-group">
                    <label for="pointsPerAd">Points per Ad</label>
                    <input type="number" id="pointsPerAd" step="0.01">
                </div>
                <div class="form-group">
                    <label for="minWithdraw">Minimum Withdraw Points</label>
                    <input type="number" id="minWithdraw">
                </div>
                <div class="form-group">
                    <label for="autoAdInterval">Auto Ad Interval (Seconds)</label>
                    <input type="number" id="autoAdInterval">
                </div>
                <div class="form-group">
                    <label for="adZoneId">Ad Network Zone ID</label>
                    <input type="text" id="adZoneId" placeholder="e.g., 9892594">
                </div>
                <div class="form-group">
                    <label for="paymentMethods">Payment Methods (comma-separated)</label>
                    <input type="text" id="paymentMethods" placeholder="e.g., bkash,nagad,rocket">
                </div>
                <div class="form-group">
                    <label for="dailyAdLimit">Daily Ad Watch Limit</label>
                    <input type="number" id="dailyAdLimit" placeholder="e.g., 20">
                </div>
                <div class="form-group">
                    <label for="referrerBonus">Referrer Bonus Points</label>
                    <input type="number" id="referrerBonus" step="0.01" placeholder="e.g., 5.00">
                </div>
                <div class="form-group">
                    <label for="refereeBonus">New User (Referee) Bonus</label>
                    <input type="number" id="refereeBonus" step="0.01" placeholder="e.g., 2.00">
                </div>
                 <div class="form-group">
                    <label for="currentVersion">App Version</label>
                    <input type="text" id="currentVersion" placeholder="e.g., 1.1">
                </div>
                <!-- নতুন ফিচার: অ্যাডমিন পাসওয়ার্ড পরিবর্তন -->
                <div class="form-group">
                    <label for="adminPassword">Admin Password</label>
                    <input type="text" id="adminPassword" placeholder="Enter new admin password">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="announcement">Broadcast Message to Users</label>
                    <textarea id="announcement" rows="3" placeholder="Leave empty for no message"></textarea>
                </div>
                <div class="form-group">
                    <label>Ads Status</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="adsEnabled" style="width: 20px; height: 20px;">
                        <label for="adsEnabled">Ads Enabled</label>
                    </div>
                </div>
            </div>
            <button class="btn-save full-width-button" style="margin-top: 15px;" onclick="saveSettings()">Save All Settings</button>
            <button class="btn-bonus full-width-button" style="margin-top: 10px;" onclick="giveBonusToAll()">Give Bonus to All Users</button>
        </div>

        <!-- Withdrawal Requests Section -->
        <div id="withdrawals" class="section-content" style="display:none;">
            <h2>Withdrawal Requests</h2>
            <div class="table-container">
                <table id="withdrawal-requests-table">
                    <thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- User Data Section -->
        <div id="users" class="section-content" style="display:none;">
            <h2>User Data</h2>
            <div class="search-container">
                <input type="text" id="user-search" onkeyup="filterUsers()" placeholder="Search by User Name...">
            </div>
            <div class="table-container">
                <table id="user-data-table">
                    <thead><tr><th>User Name</th><th>Watched Ads</th><th>Points</th><th>Registered On</th><th>Actions</th><th>Ban Control</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- নতুন ফিচার: সাপোর্ট টিকেট সেকশন -->
        <div id="support" class="section-content" style="display:none;">
            <h2>Support Tickets</h2>
            <div class="table-container">
                <table id="support-tickets-table">
                    <thead><tr><th>User Name</th><th>Message</th><th>Timestamp</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- নতুন ফিচার: ইউজার হিস্টোরি দেখার জন্য মোডাল -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
            <h3 id="modalUserName">User History</h3>
            <h4>Withdrawal History:</h4>
            <div id="modalHistoryContent" class="table-container"></div>
        </div>
    </div>


    <script>
    const firebaseConfig = {
    apiKey: "AIzaSyD-AXE8ZKzMktTVuzmSyUbAtq3UqcT2ORw",
    authDomain: "the-anisur-earnings-2025.firebaseapp.com",
    databaseURL: "https://the-anisur-earnings-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "the-anisur-earnings-2025",
    storageBucket: "the-anisur-earnings-2025.firebasestorage.app",
    messagingSenderId: "579075127891",
    appId: "1:579075127891:web:25c02c16e5b950dd54a4a6",
    measurementId: "G-YFH504KSYX"
    };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // নতুন ফিচার: পাসওয়ার্ড ডেটাবেস থেকে লোড হবে
        const adminRef = database.ref('admin');
        adminRef.child('password').once('value', (snapshot) => {
            const adminPassword = snapshot.val() || "admin123"; // ডিফল্ট পাসওয়ার্ড
            const password = prompt("Enter admin password:");
            if (password !== adminPassword) {
                document.body.innerHTML = "<h1>Access Denied</h1>";
                throw new Error("Wrong password");
            }
        });

        const settingsRef = database.ref('settings');
        const usersRef = database.ref('users');
        const withdrawalsRef = database.ref('withdrawals');
        const supportTicketsRef = database.ref('supportTickets'); // নতুন ফিচার

        // --- Load and Display Settings ---
        settingsRef.on('value', (snapshot) => {
            const settings = snapshot.val();
            if (settings) {
                document.getElementById('pointsPerAd').value = settings.pointsPerAd || 1.0;
                document.getElementById('minWithdraw').value = settings.minWithdrawPoints || 5;
                document.getElementById('adsEnabled').checked = settings.adsEnabled === true;
                document.getElementById('autoAdInterval').value = settings.autoAdIntervalSeconds || 5;
                document.getElementById('adZoneId').value = settings.adZoneId || '';
                document.getElementById('paymentMethods').value = settings.paymentMethodsCSV || 'bkash,nagad,manual';
                document.getElementById('announcement').value = settings.announcement || '';
                document.getElementById('dailyAdLimit').value = settings.dailyAdLimit || 20;
                document.getElementById('referrerBonus').value = settings.referrerBonus || 5;
                document.getElementById('refereeBonus').value = settings.refereeBonus || 2;
                document.getElementById('currentVersion').value = settings.currentVersion || '1.0';
            }
        });
        adminRef.child('password').on('value', (snapshot) => { // নতুন ফিচার: পাসওয়ার্ড ফিল্ড দেখানোর জন্য
             document.getElementById('adminPassword').value = snapshot.val() || '';
        });

        // --- Save Settings ---
        function saveSettings() {
            const newPassword = document.getElementById('adminPassword').value.trim(); // নতুন ফিচার
            if (newPassword) {
                adminRef.child('password').set(newPassword);
            }
            const settings = {
                pointsPerAd: parseFloat(document.getElementById('pointsPerAd').value),
                minWithdrawPoints: parseInt(document.getElementById('minWithdraw').value),
                adsEnabled: document.getElementById('adsEnabled').checked,
                autoAdIntervalSeconds: parseInt(document.getElementById('autoAdInterval').value),
                adZoneId: document.getElementById('adZoneId').value.trim(),
                paymentMethodsCSV: document.getElementById('paymentMethods').value.trim(),
                announcement: document.getElementById('announcement').value.trim(),
                dailyAdLimit: parseInt(document.getElementById('dailyAdLimit').value),
                referrerBonus: parseFloat(document.getElementById('referrerBonus').value),
                refereeBonus: parseFloat(document.getElementById('refereeBonus').value),
                currentVersion: document.getElementById('currentVersion').value.trim()
            };
            settingsRef.set(settings).then(() => alert("Settings saved successfully!"));
        }

        // --- Load and Display User Data ---
        usersRef.on('value', (snapshot) => {
            const users = snapshot.val();
            const tableBody = document.querySelector('#user-data-table tbody');
            tableBody.innerHTML = '';
            let totalUsers = 0;
            let totalPoints = 0;
            let todayNewUsers = 0; // নতুন ফিচার
            const allUsersArray = []; // নতুন ফিচার

            if (users) {
                const today = new Date().toISOString().slice(0, 10);
                for (const userId in users) {
                    totalUsers++;
                    const user = users[userId];
                    const userPoints = user.earnedPoints || 0;
                    totalPoints += userPoints;
                    allUsersArray.push({ userId, ...user }); // নতুন ফিচার

                    if(user.createdAt && user.createdAt.slice(0, 10) === today) {
                        todayNewUsers++;
                    }

                    const isBanned = user.isBanned === true;
                    const banButtonText = isBanned ? 'Unban' : 'Ban';
                    const banButtonClass = isBanned ? 'btn-unban' : 'btn-ban';
                    const rowClass = isBanned ? 'banned-user' : '';

                    let registeredDate = 'N/A';
                    if(user.createdAt){
                        registeredDate = new Date(user.createdAt).toLocaleDateString('en-GB');
                    }

                    const row = `<tr class="${rowClass}">
                        <td>${user.userName || 'N/A'}</td>
                        <td>${user.watchedAds || 0}</td>
                        <td>${userPoints.toFixed(2)}</td>
                        <td>${registeredDate}</td>
                        <td>
                            <button class="btn-edit" onclick="editUserPoints('${userId}', ${userPoints})">Edit</button>
                            <button class="btn-bonus" onclick="giveUserBonus('${userId}')">Bonus</button>
                            <button class="btn-deduct" onclick="deductUserPoints('${userId}')">Deduct</button> <!-- নতুন ফিচার -->
                            <button class="btn-history" onclick="viewUserHistory('${userId}', '${user.userName}')">History</button> <!-- নতুন ফিচার -->
                            <button class="btn-notice" onclick="sendUserNotice('${userId}')">Notice</button> <!-- নতুন ফিচার -->
                        </td>
                        <td><button class="${banButtonClass}" onclick="toggleUserBan('${userId}', ${isBanned})">${banButtonText}</button></td>
                    </tr>`;
                    tableBody.innerHTML += row;
                }
            }
            document.getElementById('total-users').innerText = totalUsers;
            document.getElementById('total-points').innerText = totalPoints.toFixed(2);
            document.getElementById('today-new-users').innerText = todayNewUsers; // নতুন ফিচার
            
            // নতুন ফিচার: টপ আর্নার লিডারবোর্ড আপডেট
            allUsersArray.sort((a, b) => (b.earnedPoints || 0) - (a.earnedPoints || 0));
            const topEarnersTable = document.querySelector('#top-earners-table tbody');
            topEarnersTable.innerHTML = '';
            for(let i = 0; i < Math.min(10, allUsersArray.length); i++) {
                const user = allUsersArray[i];
                topEarnersTable.innerHTML += `<tr><td>${i+1}</td><td>${user.userName}</td><td>${(user.earnedPoints || 0).toFixed(2)}</td></tr>`;
            }
        });

        // --- Load and Display Withdrawal Requests ---
        withdrawalsRef.orderByChild('timestamp').on('value', (snapshot) => {
            const requests = snapshot.val();
            const tableBody = document.querySelector('#withdrawal-requests-table tbody');
            tableBody.innerHTML = '';
            let pendingCount = 0;
            if (requests) {
                 const sortedRequests = Object.entries(requests).reverse();
                for (const [reqId, req] of sortedRequests) {
                    let statusClass = '';
                    if (req.status === 'Pending') {
                        statusClass = 'status-pending';
                        pendingCount++;
                    }
                    else if (req.status === 'Approved') statusClass = 'status-approved';
                    else if (req.status === 'Denied') statusClass = 'status-denied';

                    const row = `<tr>
                        <td>${req.userName || 'N/A'}</td>
                        <td>${req.amount}</td>
                        <td>${req.method}</td>
                        <td>${req.phone}</td>
                        <td><span class="status ${statusClass}">${req.status}</span></td>
                        <td>
                            ${req.status === 'Pending' ? `
                            <button class="btn-approve" onclick="updateWithdrawalStatus('${reqId}', 'Approved')">Approve</button>
                            <button class="btn-deny" onclick="updateWithdrawalStatus('${reqId}', 'Denied', '${req.userId}', ${req.amount})">Deny</button>
                            ` : 'Processed'}
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                }
            }
            document.getElementById('pending-withdrawals').innerText = pendingCount;
        });

        // --- নতুন ফিচার: সাপোর্ট টিকেট লোড করা ---
        supportTicketsRef.on('value', (snapshot) => {
            const tickets = snapshot.val() || {};
            const tableBody = document.querySelector('#support-tickets-table tbody');
            tableBody.innerHTML = '';
            const sortedTickets = Object.entries(tickets).reverse();
            for (const [ticketId, ticket] of sortedTickets) {
                const row = `<tr>
                    <td>${ticket.userName}</td>
                    <td>${ticket.message}</td>
                    <td>${new Date(ticket.timestamp).toLocaleString()}</td>
                    <td><button class="btn-deny" onclick="resolveTicket('${ticketId}')">Resolve</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            }
        });

        // নতুন ফিচার: মেনু সিস্টেমের জন্য জাভাস্ক্রিপ্ট
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(sec => sec.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.menu-btn[onclick="showSection('${sectionId}')"]`).classList.add('active');
        }
        document.addEventListener('DOMContentLoaded', () => showSection('dashboard'));
        
        function filterUsers() {
            const input = document.getElementById('user-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('user-data-table');
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    if (td.textContent.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        
        function giveUserBonus(userId) {
            const bonusAmountStr = prompt(`Enter bonus points for user ${userId}:`);
            if (bonusAmountStr) {
                const bonusAmount = parseFloat(bonusAmountStr);
                if (!isNaN(bonusAmount) && bonusAmount > 0) {
                    const userPointsRef = database.ref(`users/${userId}/earnedPoints`);
                    userPointsRef.transaction((currentPoints) => (currentPoints || 0) + bonusAmount);
                    alert(`Successfully gave ${bonusAmount} points`);
                } else { alert("Invalid amount."); }
            }
        }

        // --- নতুন ফাংশনগুলো ---
        function deductUserPoints(userId) {
            const deductAmountStr = prompt(`Enter points to deduct from user ${userId}:`);
            if (deductAmountStr) {
                const deductAmount = parseFloat(deductAmountStr);
                if (!isNaN(deductAmount) && deductAmount > 0) {
                    const userPointsRef = database.ref(`users/${userId}/earnedPoints`);
                    userPointsRef.transaction((currentPoints) => {
                        return Math.max(0, (currentPoints || 0) - deductAmount);
                    });
                    alert(`Successfully deducted ${deductAmount} points`);
                } else { alert("Invalid amount."); }
            }
        }

        function viewUserHistory(userId, userName) {
            document.getElementById('modalUserName').innerText = `History for ${userName}`;
            const contentDiv = document.getElementById('modalHistoryContent');
            contentDiv.innerHTML = "Loading...";
            
            withdrawalsRef.orderByChild('userId').equalTo(userId).once('value', snapshot => {
                const history = snapshot.val();
                if(!history) {
                    contentDiv.innerHTML = "<p>No withdrawal history found.</p>";
                    document.getElementById('historyModal').style.display = 'block';
                    return;
                }
                
                let tableHTML = '<table><thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead><tbody>';
                const sortedHistory = Object.values(history).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                sortedHistory.forEach(req => {
                    tableHTML += `<tr>
                        <td>${new Date(req.timestamp).toLocaleDateString()}</td>
                        <td>${req.amount}</td>
                        <td>${req.method}</td>
                        <td>${req.status}</td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                contentDiv.innerHTML = tableHTML;
                document.getElementById('historyModal').style.display = 'block';
            });
        }
        
        function sendUserNotice(userId) {
            const message = prompt("Enter the notice/message for this user:");
            if(message) {
                database.ref(`users/${userId}/notice`).set(message)
                .then(() => alert("Notice sent successfully!"));
            }
        }
        
        function resolveTicket(ticketId) {
            if (confirm("Are you sure you want to mark this ticket as resolved? It will be deleted.")) {
                supportTicketsRef.child(ticketId).remove()
                .then(() => alert("Ticket resolved."));
            }
        }
        // --- নতুন ফাংশন শেষ ---

        function giveBonusToAll() {
            const bonusAmountStr = prompt("Enter bonus points to give to ALL users:");
             if (bonusAmountStr) {
                const bonusAmount = parseFloat(bonusAmountStr);
                if (!isNaN(bonusAmount) && bonusAmount > 0) {
                    if (confirm(`Are you sure you want to give ${bonusAmount} points to EVERY user?`)) {
                        usersRef.once('value').then((snapshot) => {
                            const updates = {};
                            snapshot.forEach((childSnapshot) => {
                                const newPoints = (childSnapshot.val().earnedPoints || 0) + bonusAmount;
                                updates[childSnapshot.key + '/earnedPoints'] = newPoints;
                            });
                            database.ref('users').update(updates)
                                .then(() => alert("Bonus given to all users successfully!"))
                        });
                    }
                } else { alert("Invalid amount entered."); }
            }
        }

        function editUserPoints(userId, currentPoints) {
            const newPoints = prompt(`Enter new points for user ${userId}:`, currentPoints);
            if (newPoints !== null && !isNaN(newPoints)) {
                database.ref(`users/${userId}/earnedPoints`).set(parseFloat(newPoints));
            }
        }
        
        function updateWithdrawalStatus(reqId, newStatus, userId, amount) {
            if (confirm(`Are you sure you want to set this request to "${newStatus}"?`)) {
                database.ref(`withdrawals/${reqId}/status`).set(newStatus)
                    .then(() => {
                        if (newStatus === 'Denied') {
                             database.ref(`users/${userId}/earnedPoints`).transaction((currentPoints) => (currentPoints || 0) + amount);
                        }
                        alert("Status updated successfully!");
                    });
            }
        }

        function toggleUserBan(userId, isCurrentlyBanned) {
            const action = isCurrentlyBanned ? "unban" : "ban";
            if (confirm(`Are you sure you want to ${action} this user?`)) {
                database.ref(`users/${userId}/isBanned`).set(!isCurrentlyBanned);
            }
        }
    </script>
</body>
</html>
